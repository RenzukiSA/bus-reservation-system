<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reservas de Autobuses</title>
    <link rel="stylesheet" href="/public/css/styles.css?v=1.6">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="images/logo.png" alt="Transportes Express" class="logo-img">
                <span>Transportes Express</span>
            </div>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="#home" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#reservations" class="nav-link">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Mis Reservas</span>
                </a>
            </li>
        </ul>
        <!-- Controles de Sesión de Usuario -->
        <div class="user-session-controls">
            <a href="/admin" id="admin-link" class="nav-link is-hidden">
                <i class="fas fa-user-shield"></i>
                <span>Admin</span>
            </a>
            <div id="user-info" class="user-info is-hidden">
                <i class="fas fa-user-circle"></i>
                <span id="user-name"></span>
            </div>
            <a href="/login" id="login-link" class="nav-link">
                <i class="fas fa-sign-in-alt"></i>
                <span>Iniciar Sesión</span>
            </a>
            <a href="#" id="logout-link" class="nav-link is-hidden">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </nav>

    <!-- Mobile Menu Toggle -->
    <button class="sidebar-toggle" aria-label="Abrir menú">
        <i class="fas fa-bars"></i>
    </button>

    <main class="main">
        <!-- Home Section: Search and Results -->
        <section id="home" class="section" data-view="home">
            <div class="home-grid">
                <article class="card" data-testid="search-card">
                    <div class="card-header">
                        <h3><i class="fas fa-search"></i> Buscar Viaje</h3>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="form-group">
                                <label for="origin"><i class="fas fa-map-marker-alt"></i> Desde</label>
                                <select id="origin" required>
                                    <option value="" disabled selected>Selecciona origen</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="destination"><i class="fas fa-exchange-alt"></i> Hasta</label>
                                <select id="destination" required>
                                    <option value="" disabled selected>Selecciona destino</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="travelDate"><i class="fas fa-calendar-alt"></i> Fecha de ida</label>
                                <input type="date" id="travelDate" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">BUSCAR</button>
                        </form>
                    </div>
                </article>

                <article class="card" data-testid="results-card">
                    <div class="card-header">
                        <h3><i class="fas fa-bus"></i> Viajes Disponibles</h3>
                    </div>
                    <div class="card-body">
                        <div id="loading" class="loading-spinner is-hidden"><i class="fas fa-spinner fa-spin"></i></div>
                        <div id="schedulesList"></div>
                        <div id="results-initial-state" class="empty-state">
                            <i class="fas fa-search-location"></i>
                            <h4>Realiza una búsqueda</h4>
                            <p>Usa el formulario para encontrar tu próximo viaje.</p>
                        </div>
                    </div>
                </article>
            </div>
        </section>

        <!-- Seat Selection Section -->
        <section id="seat-selection-view" class="section is-hidden" data-view="seat">
            <div class="container">
                <article class="card" data-testid="seat-selection-card">
                    <div class="card-header">
                        <button id="backToResults" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Volver</button>
                        <h3><i class="fas fa-chair"></i> Selecciona tus Asientos</h3>
                        <span id="selectedScheduleInfo"></span>
                    </div>
                    <div class="card-body seat-map-container">
                        <div class="bus-layout">
                            <div class="bus-front">
                                <i class="fas fa-steering-wheel"></i>
                                <span>Conductor</span>
                            </div>
                            <div id="seatMap" class="seat-map"></div>
                            <!-- Empty State for Seat Map -->
                            <div id="noSeatMap" class="empty-state hidden">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h4>No se pudo cargar el mapa de asientos</h4>
                                <p>Por favor, selecciona un viaje para ver los asientos.</p>
                            </div>
                        </div>
                        <div class="seat-legend">
                            <div class="legend-item"><div class="seat-demo available"></div><span>Disponible</span></div>
                            <div class="legend-item"><div class="seat-demo selected"></div><span>Seleccionado</span></div>
                            <div class="legend-item"><div class="seat-demo occupied"></div><span>Ocupado</span></div>
                            <div class="legend-item"><div class="seat-demo premium"></div><span>Premium</span></div>
                        </div>
                    </div>
                </article>
                <article class="card" data-testid="summary-card">
                    <div class="card-header">
                        <h3><i class="fas fa-shopping-cart"></i> Resumen de Reserva</h3>
                    </div>
                    <div class="card-body price-summary">
                        <div class="price-summary">
                            <div class="selected-seats-info">
                                <h4>Asientos: <span id="selectedSeatsCount">0</span></h4>
                                <div id="selectedSeatsList"></div>
                            </div>
                            <div class="total-price">
                                <h3>Total: $<span id="totalPrice">0.00</span></h3>
                            </div>
                            <button id="proceedToReservation" class="btn btn-primary btn-block" disabled>
                                <i class="fas fa-credit-card"></i> Proceder con la Reserva
                            </button>
                        </div>
                    </div>
                </article>
            </div>
        </section>

        <!-- Checkout Section -->
        <section id="checkout-view" class="section is-hidden" data-view="checkout">
            <div class="container">
                <article class="card" data-testid="customer-form-card">
                    <h3><i class="fas fa-user"></i> Información del Pasajero</h3>
                    <form id="customerForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName">Nombre Completo *</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerPhone">Teléfono *</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email (opcional)</label>
                            <input type="email" id="customerEmail">
                        </div>
                        
                        <div class="reservation-summary">
                            <h4>Resumen de Reserva</h4>
                            <div id="reservationSummary"></div>
                        </div>

                        <button type="submit" class="btn btn-success btn-large">
                            <i class="fas fa-check"></i> Confirmar Reserva
                        </button>
                    </form>
                </article>
            </div>
        </section>

        <!-- Success Section -->
        <section id="success-view" class="section is-hidden" data-view="success">
            <div class="container">
                <div id="paymentInstructions" class="payment-instructions">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>¡Reserva Creada Exitosamente!</h3>
                    <div class="reservation-details">
                        <p><strong>ID de Reserva:</strong> <span id="reservationId"></span></p>
                        <p><strong>Total a Pagar:</strong> $<span id="finalPrice"></span></p>
                        <p><strong>Tiempo límite:</strong> <span id="paymentDeadline"></span></p>
                    </div>
                    
                    <div class="payment-steps">
                        <h4><i class="fas fa-whatsapp"></i> Instrucciones de Pago</h4>
                        <ol>
                            <li>Realiza el pago por transferencia bancaria o depósito</li>
                            <li>Toma una foto del comprobante de pago</li>
                            <li>Envía el comprobante por WhatsApp al número: <strong id="whatsappNumber"></strong></li>
                            <li>Incluye tu ID de reserva en el mensaje</li>
                        </ol>
                        
                        <div class="timer-container">
                            <div class="timer">
                                <i class="fas fa-clock"></i>
                                <span>Tiempo restante: </span>
                                <span id="countdown">15:00</span>
                            </div>
                        </div>
                        
                        <div class="success-actions">
                            <button id="copyReservationIdBtn" class="btn btn-secondary"><i class="fas fa-copy"></i> Copiar ID</button>
                            <a id="whatsappPayLink" class="btn btn-whatsapp" target="_blank"><i class="fab fa-whatsapp"></i> Pagar ahora</a>
                            <!-- TODO: Implementar endpoint GET /reservations/:id/ticket.pdf -->
                            <a id="downloadPdfBtn" href="#" class="btn btn-info is-hidden" target="_blank"><i class="fas fa-file-pdf"></i> Descargar PDF</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reservations Lookup Section -->
        <section id="reservations" class="section is-hidden" data-view="lookup">
            <div class="container">
                <h2><i class="fas fa-ticket-alt"></i> Consultar Reserva</h2>
                <div class="search-card">
                    <form id="reservationSearchForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="searchReservationId">ID de Reserva</label>
                                <input type="text" id="searchReservationId" placeholder="Ingresa tu ID de reserva" required>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div id="reservationDetails" class="reservation-details-card hidden"></div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="section is-hidden" data-view="admin">
            <div class="container">
                <h2><i class="fas fa-cog"></i> Panel Administrativo</h2>
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
                    <button class="tab-btn" data-tab="reservations-admin">Reservas</button>
                    <button class="tab-btn" data-tab="routes-admin">Rutas</button>
                    <button class="tab-btn" data-tab="buses-admin">Autobuses</button>
                </div>
                
                <div id="dashboard" class="tab-content active">
                    <div class="dashboard-stats" id="dashboardStats"></div>
                </div>
                
                <div id="reservations-admin" class="tab-content">
                    <div class="admin-section">
                        <h3>Gestión de Reservas</h3>
                        <div id="adminReservations"></div>
                    </div>
                </div>
                
                <div id="routes-admin" class="tab-content">
                    <div class="admin-section">
                        <h3>Gestión de Rutas</h3>
                        <div id="adminRoutes"></div>
                    </div>
                </div>
                
                <div id="buses-admin" class="tab-content">
                    <div class="admin-section">
                        <h3>Gestión de Autobuses</h3>
                        <div id="adminBuses"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Transportes Express. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Modal -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Edit Route Modal -->
    <div id="editRouteModal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditRouteModal()">&times;</span>
            <h3>Editar Ruta</h3>
            <form id="editRouteForm" class="form-card">
                <input type="hidden" id="editRouteId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editRouteOrigin">Origen</label>
                        <input type="text" id="editRouteOrigin" required>
                    </div>
                    <div class="form-group">
                        <label for="editRouteDestination">Destino</label>
                        <input type="text" id="editRouteDestination" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editRouteDistance">Distancia (km)</label>
                        <input type="number" id="editRouteDistance" required>
                    </div>
                    <div class="form-group">
                        <label for="editRoutePrice">Precio Base</label>
                        <input type="number" step="0.01" id="editRoutePrice" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditRouteModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal hidden">
        <div class="modal-content">
            <h3>Acceso de Administrador</h3>
            <form id="adminLoginForm" class="form-card">
                <div class="form-group">
                    <label for="adminPassword">Contraseña</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Ingresar</button>
                </div>
                <p id="loginError" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="/public/js/shared-validation.js"></script>
    <script src="/public/js/wa.js"></script>
    <script src="/public/js/app.js"></script>
    <script src="/public/js/seatmap.js"></script>
</body>
</html>
